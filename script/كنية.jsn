module.exports.config = {
  name: "in",
  version: "2.0.0",
  hasPermssion: 2,
  credits: "ZINO - ØªØ·ÙˆÙŠØ± Ù…Ù†ØªØµØ±",
  description: "ØªØºÙŠÙŠØ± ÙƒÙ†ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù…Ø¹ Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù",
  commandCategory: "Ø®Ø¯Ù…Ø§Øª",
  usages: "ÙƒÙ†ÙŠØ© [Ø§Ù„Ø±Ø¯ Ø¨Ø§Ù„ÙƒÙ†ÙŠØ©] Ø£Ùˆ ÙƒÙ†ÙŠØ© Ø§ÙŠÙ‚Ø§Ù",
  cooldowns: 5
};

// Ù…ØªØºÙŠØ± Ù„ØªØªØ¨Ø¹ Ø¹Ù…Ù„ÙŠØ§Øª ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ†ÙŠØ© Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
global.nicknameProcesses = global.nicknameProcesses || new Map();

module.exports.handleReply = async function({ api, event, handleReply }) {
  const { threadID, messageID, senderID, body } = event;
  if (handleReply.author != senderID) return;

  const newNickname = body.trim();
  if (!newNickname) return api.sendMessage("âš ï¸ | Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ†ÙŠØ© ØµØ­ÙŠØ­Ø©", threadID, messageID);

  const threadInfo = await api.getThreadInfo(threadID);
  const participantIDs = threadInfo.participantIDs;

  // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
  global.nicknameProcesses.set(threadID, {
    stop: false,
    completed: 0,
    remaining: participantIDs.length,
    nickname: newNickname,
    total: participantIDs.length
  });

  api.sendMessage(
    `â³ | Ø¬Ø§Ø±ÙŠ ØªØºÙŠÙŠØ± ÙƒÙ†ÙŠØ© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡...\nğŸ“ | Ø§Ù„ÙƒÙ†ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: "${newNickname}"\nğŸ‘¥ | Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ: ${participantIDs.length} Ø¹Ø¶Ùˆ\n\nğŸ’¡ | Ø§Ø³ØªØ®Ø¯Ù… "ÙƒÙ†ÙŠØ© Ø§ÙŠÙ‚Ø§Ù" Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©`,
    threadID, messageID
  );

  let success = 0;
  let failed = 0;

  for (let i = 0; i < participantIDs.length; i++) {
    const userID = participantIDs[i];

    // ÙØ­Øµ Ø¥Ø°Ø§ ØªÙ… Ø·Ù„Ø¨ Ø§Ù„Ø¥ÙŠÙ‚Ø§Ù
    const process = global.nicknameProcesses.get(threadID);
    if (process && process.stop) {
      api.sendMessage(
        `â¹ï¸ | ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©!\n\n` +
        `âœ… | ØªÙ… ØªØºÙŠÙŠØ±: ${success} Ø¹Ø¶Ùˆ\n` +
        `âŒ | ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ±: ${failed} Ø¹Ø¶Ùˆ\n` +
        `â¸ï¸ | Ù…ØªØ¨Ù‚ÙŠ: ${participantIDs.length - i} Ø¹Ø¶Ùˆ`,
        threadID, messageID
      );
      global.nicknameProcesses.delete(threadID);
      return;
    }

    try {
      await api.changeNickname(newNickname, threadID, userID);
      success++;
    } catch {
      failed++;
    }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
    if (process) {
      process.completed = success + failed;
      process.remaining = participantIDs.length - (success + failed);
    }

    // Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø£Ø¹Ø¶Ø§Ø¡
    if ((success + failed) % 10 === 0 && (success + failed) < participantIDs.length) {
      api.sendMessage(
        `ğŸ“Š | ØªÙ‚Ø¯Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ©: ${success + failed}/${participantIDs.length}\nâœ… | Ù†Ø¬Ø­: ${success} | âŒ ÙØ´Ù„: ${failed}`,
        threadID
      );
    }

    await new Promise(resolve => setTimeout(resolve, 1000));
  }

  // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù…Ù† Ø§Ù„ØªØªØ¨Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
  global.nicknameProcesses.delete(threadID);

  return api.sendMessage(
    `âœ… | ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ†ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n\n` +
    `ğŸ‘¥ | ØªÙ… ØªØºÙŠÙŠØ±: ${success} Ø¹Ø¶Ùˆ\n` +
    `âŒ | ÙØ´Ù„ ÙÙŠ ØªØºÙŠÙŠØ±: ${failed} Ø¹Ø¶Ùˆ\n` +
    `ğŸ“ | Ø§Ù„ÙƒÙ†ÙŠØ©: "${newNickname}"`,
    threadID, messageID
  );
};

module.exports.run = async function({ api, event, args }) {
  const { threadID, messageID, senderID } = event;

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± "Ø§ÙŠÙ‚Ø§Ù"
  if (args[0] === "Ø§ÙŠÙ‚Ø§Ù" || args[0] === "stop") {
    if (global.nicknameProcesses.has(threadID)) {
      global.nicknameProcesses.get(threadID).stop = true;
      return api.sendMessage("â¹ï¸ | ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø¹Ù…Ù„ÙŠØ© ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ†ÙŠØ§Øª", threadID, messageID);
    } else {
      return api.sendMessage("âŒ | Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© ØªØºÙŠÙŠØ± ÙƒÙ†ÙŠØ§Øª Ø¬Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹", threadID, messageID);
    }
  }

  // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø£Ù…Ø± "Ø­Ø§Ù„Ø©" Ù„Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
  if (args[0] === "Ø­Ø§Ù„Ø©" || args[0] === "status") {
    if (global.nicknameProcesses.has(threadID)) {
      const process = global.nicknameProcesses.get(threadID);
      return api.sendMessage(
        `ğŸ“Š | Ø­Ø§Ù„Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙƒÙ†ÙŠØ§Øª:\nâ€¢ ØªÙ… ØªØºÙŠÙŠØ±: ${process.completed} Ø¹Ø¶Ùˆ\nâ€¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${process.remaining} Ø¹Ø¶Ùˆ\nâ€¢ Ø§Ù„ÙƒÙ†ÙŠØ©: ${process.nickname}`,
        threadID, messageID
      );
    } else {
      return api.sendMessage("âŒ | Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ© ØªØºÙŠÙŠØ± ÙƒÙ†ÙŠØ§Øª Ø¬Ø§Ø±ÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹", threadID, messageID);
    }
  }

  return api.sendMessage(
    "ğŸ’¬ | Ù‚Ù… Ø¨Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø§Ù„ÙƒÙ†ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØ¹ÙŠÙŠÙ†Ù‡Ø§ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡\n\nğŸ“ Ø£ÙˆØ§Ù…Ø± Ø¥Ø¶Ø§ÙÙŠØ©:\nâ€¢ ÙƒÙ†ÙŠØ© Ø§ÙŠÙ‚Ø§Ù - Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¹Ù…Ù„ÙŠØ©\nâ€¢ ÙƒÙ†ÙŠØ© Ø­Ø§Ù„Ø© - Ù„Ù…Ø¹Ø±ÙØ© Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ©",
    threadID,
    (error, info) => {
      if (error) return;
      global.client.handleReply.push({
        name: this.config.name,
        messageID: info.messageID,
        author: senderID
      });
    },
    messageID
  );
};
