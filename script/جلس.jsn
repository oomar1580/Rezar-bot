const fs = require('fs-extra');
const path = require('path');
const axios = require('axios');
const pathData = path.join(__dirname, '../commands/cache/antiavtbox.json');

module.exports.config = {
    name: "antiavtbox",
    eventType: ["log:thread-icon"],
    version: "1.0.0",
    credits: "",
    description: "Ngฤn chแบทn viแปc thay ฤแปi แบฃnh ฤแบกi diแปn nhรณm",
};

module.exports.run = async function ({ event, api, Threads }) {
    const { logMessageData, threadID } = event;
    try {
        let antiData = await fs.readJSON(pathData);
        let threadEntry = antiData.find(entry => entry.threadID === threadID);
        if (!threadEntry) return;
        const thread = await Threads.getInfo(threadID);
        const currentImgSrc = thread.imageSrc;
        if (currentImgSrc !== threadEntry.url) {
            api.sendMessage("ใ โ๏ธ ใโค ุชู ุงููุดู ุนู ุชุบููุฑ ุตูุฑุฉ ุงููุฌููุนุฉ โ\nโฅ ุฌุงุฑู ุงุณุชุฑุฌุงุน ุงูุตูุฑุฉ ุงูุฃุตููุฉ... ๐", threadID);
            try {
                const response = await axios.get(threadEntry.url, { responseType: 'stream' });
                await api.changeThreadImage(response.data, threadID, (err) => {
                    if (err) {
                        api.sendMessage("ใ โ๏ธ ใโค ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงุณุชุฑุฌุงุน ุงูุตูุฑุฉ โ", threadID);
                    } else {
                        api.sendMessage("ใ โ ใโค ุชู ุงุณุชุฑุฌุงุน ุตูุฑุฉ ุงููุฌููุนุฉ ุจูุฌุงุญ! ๐", threadID);
                    }
                });
            } catch (error) {
                api.sendMessage("ใ โ๏ธ ใโค ูุดู ูู ุชุญููู ุงูุตูุฑุฉ ุงูุฃุตููุฉ ๐", threadID);
            }
        }
    } catch (error) {
        api.sendMessage("ใ โ๏ธ ใโค ููุน ุฎุทุฃ ุฃุซูุงุก ูุนุงูุฌุฉ ุชุบููุฑ ุงูุตูุฑุฉ ๐ข", threadID);
    }
};
